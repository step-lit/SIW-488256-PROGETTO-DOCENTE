<!DOCTYPE html>

<html lang="it" xmlns:th="http://www.thymeleaf.org">
	
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
		<link rel="stylesheet" type="text/css" th:href="@{/css/visualizza-libro.css}"/>
		<title>Dettagli Libro – Libreria Universo</title>
	</head>
	
	<body>
		
		<header class="site-header">
			<nav class="navbar-container">
				<div class="nav-left"></div>
						
				<div class="nav-center">
					<div class="logo-container">
						<a th:href="@{/}">
						    <img th:src="@{/images/logo.png}" alt="Logo libreria" id="nav-logo">
						   </a>
					</div>
					
					<div class="nav-links">
						<a th:href="@{/index}">Home</a>
						<a th:href="@{/libri}">Libri</a>
						<a th:href="@{/autori}">Autori</a>
						<a th:href="@{/contatti}">Contatti</a>
					</div>
				</div>
						
				<div class="nav-right">
					<div class="user-actions">
						
						<div th:if="${userDetails}" class="user-greeting">
							<p th:text="'Ciao, ' + ${userDetails.username} + '!'">Ciao, Utente!</p>
						</div>
						
						<form th:if="${userDetails}" th:action="@{/logout}" method="POST" style="display: inline;">
							<button type="submit" class="btn-custom btn-logout">Logout</button>
						</form>
										
						<form th:unless="${userDetails}" th:action="@{/login}" method="GET" style="display: inline;">
							<button type="submit" class="btn-custom btn-login">Login</button>
						</form>
										
						<form th:unless="${userDetails}" th:action="@{/register}" method="GET" style="display: inline;">
							<button type="submit" class="btn-custom btn-register">Registrati</button>
						</form>
						
					</div>
				</div>
			</nav>
		</header>
		
		<main>
		    <section class="visualizza-libro-container" th:if="${libro}">
				
				<div class="alert alert-primary" role="alert" th:text="${successModificaLibro}" th:if="${successModificaLibro}"></div>
				<div class="alert alert-primary" role="alert" th:text="${successAggiungiRecensione}" th:if="${successAggiungiRecensione}"></div>
				<div class="alert alert-primary" role="alert" th:text="${successCancellaRecensione}" th:if="${successCancellaRecensione}"></div>
				
				<h2>Dettagli del libro</h2>

					<div class="libro-details">
						            
						<div class="libro-cover">
							<div th:id="'carouselLibro' + ${libro.id}" class="carousel slide">
											
								<div class="carousel-inner">
									
									<div th:each="immagine, loop : ${libro.immagini}" class="carousel-item" th:classappend="${loop.first ? 'active' : ''}">
										<img th:src="${immagine.toBase64Image()}" class="d-block w-100" alt="Immagine del libro">              
									</div>
						                    
									<div th:if="${!#lists.isEmpty(libro.immagini) && #lists.size(libro.immagini) > 1}">
							        	<button class="carousel-control-prev" type="button" th:data-bs-target="'#carouselLibro' + ${libro.id}" data-bs-slide="prev">
							            	<span class="carousel-control-prev-icon" aria-hidden="true"></span>
							            	<span class="visually-hidden">Previous</span>
							            </button>
							                    
							            <button class="carousel-control-next" type="button" th:data-bs-target="'#carouselLibro' + ${libro.id}" data-bs-slide="next">
							                <span class="carousel-control-next-icon" aria-hidden="true"></span>
							                <span class="visually-hidden">Next</span>
							            </button>
									</div>	
									
						        </div>
								
						    </div>
						</div>
									
						<div class="libro-info">
							
							<h1 th:text="${libro.title}">Titolo del Libro</h1>

							<div class="info-item">
								<strong>Anno di pubblicazione:</strong>
								<span th:text="${libro.yearOfPublication}">Anno</span>
							</div>

							<div class="info-item">
								<strong>Autori:</strong>
								<span th:if="${#lists.isEmpty(libro.autori)}">Non specificato.</span>
								<ul th:unless="${#lists.isEmpty(libro.autori)}">
									<li th:each="autore : ${libro.autori}" th:text="${autore.name} + ' ' + ${autore.surname}">Nome Autore</li>
								</ul>
							</div>
															
							<div class="libro-rating">
								<img th:src="@{/images/star.png}" alt="Stella" class="star-icon">
								<span class="rating-avg" th:text="${#numbers.formatDecimal(libro.getAverageVote(), 1, 1)}">0.0</span>
								<span class="rating-count" th:text="'(' + ${libro.getReviewCount()} + ' recensioni)'">(0)</span>
									
								<div class="libro-edit">
									<a th:if="${!isRecensitoByUtente}" sec:authorize="hasAuthority('USER_ROLE')"
									   th:href="@{/recensioni/aggiungi-recensione/{libroId}(libroId=${libro.id})}" 
									   class="btn-recensione">Scrivi recensione</a>
									   
									<a th:if="${isRecensitoByUtente}" sec:authorize="hasAuthority('USER_ROLE')"
									   href="javascript:void(0);"
									   onclick="avvisoRecensioneEsistente()"
									   class="btn-recensione">Scrivi recensione</a>
										   
									<a sec:authorize="hasAuthority('ADMIN_ROLE')" th:href="@{/libri/modifica-libro/{libroId}(libroId=${libro.id})}">Modifica libro</a>
									<a sec:authorize="hasAuthority('ADMIN_ROLE')" th:href="@{/libri/cancella-libro/{libroId}(libroId=${libro.id})}" onclick="return confirmCancella(this.href);">Cancella libro</a>
								</div>
							</div>			
						</div>
									
					</div>
		    </section>
			
			<section class="recensioni-section">
			    <h2>Recensioni del libro</h2>
			    
			    <div th:if="${#lists.isEmpty(libro.recensioni)}">
			        <p class="no-recensioni">Non ci sono ancora recensioni per questo libro.</p>
			    </div>
			    
			    <div class="recensioni-container" th:unless="${#lists.isEmpty(libro.recensioni)}">
			        
			        <div class="recensione-item" th:each="recensione : ${libro.recensioni}">
						
			            <div class="recensione-header">
							<div class="recensione-header-content">
								
			                	<h4 class="recensione-titolo" th:text="${recensione.title}"></h4>
								
			                	<div class="recensione-voto">
									<img th:src="@{/images/star.png}" alt="Stella" class="star-icon">
			                    	<span class="rating-vote" th:text="${#numbers.formatDecimal(recensione.vote, 1, 1)}">0.0</span>
			                	</div>
								
							</div>	
			            </div>
						
			            <div class="recensione-autore">
			                Inviata da <strong th:text="${recensione.utente.name}">Nome Utente</strong>
			            </div>
						
			            <p class="recensione-testo" th:text="${recensione.text}">Testo della recensione.</p>
						<a class="recensione-canc-btn" 
						   th:href="@{/recensioni/cancella-recensione/{recensioneId}/{libroId}(recensioneId=${recensione.id}, libroId=${libro.id})}" 
						   onclick="return confirmCancella(this.href);"
						   sec:authorize="hasAuthority('ADMIN_ROLE')">Cancella recensione</a>
			        </div>

			    </div>
			</section>
		</main>
		
		<footer>
			<div class="bottom-nav-links">
				<a th:href="@{/}">Home</a>
				<span>|</span>
				<a th:href="@{/libri}">Libri</a>
				<span>|</span>
				<a th:href="@{/autori}">Autori</a>
				<span>|</span>
				<a th:href="@{/contatti}">Contatti</a>
			</div>
			<p>© Copyright 2025. Tutti i diritti riservati.</p>
		</footer>	
		
		<script>
			function confirmCancella(urlCancellazione) {
				if (window.confirm("Sei sicuro di voler effettuare la cancellazione?")) {
					window.location.href = urlCancellazione; 
				}
				return false;
			}
			
			function avvisoRecensioneEsistente() {
				alert("Hai già inserito una recensione per questo libro!");
			}				
		</script>
		
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
		
	</body>
	
</html>